#!/bin/bash

# --- Check if running as root ---
if [[ "$(id -u)" -ne 0 ]]; then
    dialog --title "Permission Denied" --msgbox "This program must be run as root.\nExiting..." 8 50
    clear
    exit 1
fi

# --- Intro Message ---
dialog --title "Server Management Update" --msgbox \
"Server Management (SM-GUI) will be updated to the latest version from GitHub.

This will download and install the latest installer script." 10 100

# --- Confirmation Prompt ---
dialog --title "Update SM-GUI?" --yesno "Do you want to update Server Management now?" 7 60
CONFIRM=$?

if [[ $CONFIRM -eq 0 ]]; then
    # --- Progress Dialog with Gauge ---
    PIPE=$(mktemp -u)
    mkfifo "$PIPE"
    dialog --backtitle "Server Management Update" \
           --title "Updating..." \
           --gauge "Preparing update..." 10 60 0 <"$PIPE" &
    exec 3>"$PIPE"

    (
        echo "10" >"$PIPE"; echo "XXX" >"$PIPE"; echo "Cleaning old autostart entry..." >"$PIPE"; echo "XXX" >"$PIPE"
        sed -i '/server-manager/d' /root/.bash_profile
        sleep 0.5

        echo "30" >"$PIPE"; echo "XXX" >"$PIPE"; echo "Installing wget..." >"$PIPE"; echo "XXX" >"$PIPE"
        dnf -y install wget >/dev/null 2>&1
        sleep 0.5

        echo "60" >"$PIPE"; echo "XXX" >"$PIPE"; echo "Downloading installer..." >"$PIPE"; echo "XXX" >"$PIPE"
        cd /root/
        wget -q https://raw.githubusercontent.com/fumatchu/RADS-SM/main/RADS-SMInstaller.sh
        chmod 700 ./RADS-SMInstaller.sh
        sleep 0.5

        echo "80" >"$PIPE"; echo "XXX" >"$PIPE"; echo "Running installer..." >"$PIPE"; echo "XXX" >"$PIPE"
        /root/RADS-SMInstaller.sh >/dev/null 2>&1
        sleep 0.5

        echo "100" >"$PIPE"; echo "XXX" >"$PIPE"; echo "Update complete!" >"$PIPE"; echo "XXX" >"$PIPE"
    )

    exec 3>&-
    rm -f "$PIPE"

    # --- Completion Message ---
    dialog --title "Update Complete" --msgbox "Server Management has been updated to the latest version." 7 60

    # --- Launch SM-GUI ---
    server-manager

    clear
    exit 0
else
    dialog --title "Cancelled" --msgbox "Update cancelled. No changes made." 6 50
    clear
    exit 0
fi
