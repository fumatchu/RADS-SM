#!/bin/bash
set -euo pipefail

# === Config ===
OUT_DIR="/root/RSAT-GENERATED-BAT-FILE"
OUT_FILE="$OUT_DIR/rsat-admin.bat"

FQDN="$(hostname -f 2>/dev/null || hostname)"
ADDOMAIN="$(hostname | sed 's/^[^.:]*[.:]//' | cut -d. -f1 | sed -e 's/\(.*\)/\U\1/')"

# === Checks ===
if [[ $EUID -ne 0 ]]; then
  echo "This program must be run as root." >&2
  exit 1
fi

if ! command -v dialog >/dev/null 2>&1; then
  echo "'dialog' not found. Please install it first (dnf -y install dialog)."
  exit 1
fi

# === Intro text ===
intro_text="Active Directory Management
Generate an RSAT launch batch file for administering this domain from a non-domain-joined Windows machine.

What this does:
• Creates a batch file on this server at:
  $OUT_FILE

The batch launches MMC with 'Run as different user' using your AD admin.

Before use on Windows:
• Point your Windows device's DNS to this AD server.

To get the file off this server:
• Cockpit (https://${FQDN}:9090) – use the file browser
• Or SCP/SFTP (e.g., WinSCP).
"

# === Dialog Flow ===
dialog --title "RSAT Batch Generator" --msgbox "$intro_text" 20 78

dialog --title "Proceed?" --yesno "Generate RSAT batch file now?\n\nServer: $FQDN\nAD short domain: $ADDOMAIN\n\nOutput: $OUT_FILE" 12 70
if [[ $? -ne 0 ]]; then
  clear
  echo "Cancelled."
  exit 1
fi

mkdir -p "$OUT_DIR"

{
  echo 0
  sleep 0.1
  cat > "$OUT_FILE" <<'BAT'
@echo off
:: BatchGotAdmin
::-------------------------------------
REM  --> Check for permissions
>nul 2>&1 "%SYSTEMROOT%\system32\cacls.exe" "%SYSTEMROOT%\system32\config\system"

REM --> If error flag set, we do not have admin.
if '%errorlevel%' NEQ '0' (
    echo Requesting administrative privileges...
    goto UACPrompt
) else ( goto gotAdmin )

:UACPrompt
    echo Set UAC = CreateObject^("Shell.Application"^) > "%temp%\getadmin.vbs"
    set params = %*:"="
    echo UAC.ShellExecute "cmd.exe", "/c %~s0 %params%", "", "runas", 1 >> "%temp%\getadmin.vbs"

    "%temp%\getadmin.vbs"
    del "%temp%\getadmin.vbs"
    exit /B

:gotAdmin
    pushd "%CD%"
    CD /D "%~dp0"
::--------------------------------------

BAT
  echo 45
  sleep 0.1
  echo "runas /netonly /noprofile /u:${ADDOMAIN}\Administrator mmc.exe" >> "$OUT_FILE"
  echo 90
  sleep 0.1
  chmod 0644 "$OUT_FILE"
  echo 100
  sleep 0.1
} | dialog --title "Generating" --gauge "Creating RSAT batch file..." 8 60 0

msg="RSAT batch file generated!\n\nPath on this server:\n  $OUT_FILE\n\nAccess options:\n• Cockpit:  https://${FQDN}:9090  (file browser)\n• SCP/SFTP: use WinSCP or similar.\n\nOn Windows, double-click or right-click → Run as administrator."
dialog --title "Success" --msgbox "$msg" 14 70

clear
