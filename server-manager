#!/usr/bin/env bash
# set -Eeuo pipefail

cleanup() { stty sane 2>/dev/null || true; tput cnorm 2>/dev/null || true; tput rmcup 2>/dev/null || true; }
trap cleanup EXIT INT TERM

cd /root 2>/dev/null || cd "$HOME" || true

if (( EUID != 0 )); then
  dialog --title "Permission Denied" --msgbox "Server Manager must be run as root." 7 60
  clear; exit 1
fi

command -v dialog >/dev/null 2>&1 || { echo "dialog is required (dnf -y install dialog)"; exit 1; }

TITLE="Server Manager"
MOTD_FILE="/etc/motd"
EXECUTABLE="/usr/bin/samba-dnf-pkg-update"

if [[ -s "$MOTD_FILE" ]]; then
  dialog --title "Message of the Day" --msgbox "$(sed -e 's/\r$//' "$MOTD_FILE")" 20 80
  if [[ -x "$EXECUTABLE" ]]; then
    if dialog --yesno "Run $EXECUTABLE now?\n\n(We'll exit the Server Manager UI and run it directly in the terminal.)" 9 76; then
      dialog --clear; clear; stty sane 2>/dev/null || true
      exec "$EXECUTABLE"
    fi
  fi
fi

# ── Section headers in BLACK ───────────────────────────────────────────────────
# Using --colors: \Z0=black, \Zn=reset
SEP_APP=$'\Z0────────── Application Management ──────────\Zn'
SEP_SRV=$'\Z0──────────── Server Management ─────────────\Zn'
SEP_HLP=$'\Z0──────────────────── Help ───────────────────\Zn'

items=(
  S1 "$SEP_APP"
   1 "Active Directory Management"
   2 "NTP Management"
   3 "DHCP Management"
   4 "Samba Management"
   5 "Fail2Ban Management"

  S2 "$SEP_SRV"
   6 "Service Management"
   7 "System Management"
   8 "Backup/Restore"
   9 "Server Management Options"
  10 "System Tools"

  S3 "$SEP_HLP"
  11 "Welcome to Server Manager"
)

while true; do
  choice=$(dialog --colors --title "$TITLE" --backtitle "Server Management" \
                  --menu "Please select" 22 70 16 "${items[@]}" 2>&1 >/dev/tty) || break

  [[ "$choice" =~ ^S[0-9]+$ ]] && continue

  case "$choice" in
    1)  /root/.servman/ADMan ;;
    2)  /root/.servman/NTPMan/ntp_admin.sh ;;
    3)  /root/.servman/DHCPMan ;;
    4)  /root/.servman/SambaMan ;;
    5)  /root/.servman/jail-admin.sh ;;
    6)  /root/.servman/ServiceMan ;;
    7)  /root/.servman/SYSMan ;;
    8)  /root/.servman/BackupMan.sh ;;
    9)  /root/.servman/SERVMan ;;
    10) /root/.servman/TOOLMan ;;
    11) /root/.servman/welcome.readme ;;
  esac
done

clear
exit 0
